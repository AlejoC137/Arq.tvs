import{c as xe,r as i,j as e,u as he,C as fe,P as be,D as me,G as ye,I as je,J as we,K as Ne,L as ve,M as ke,g as O,E as Y,N as Z,l as _e}from"./index-cawTiIuy.js";import{D as De,C as Ee,u as U,w as Ce}from"./xlsx-wyOr0oje.js";/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=xe("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]),ee=r=>{if(!r||typeof r!="string"||r.split("/").length!==3)return"";const[y,w,f]=r.split("/");return`${f}-${w.padStart(2,"0")}-${y.padStart(2,"0")}`},Pe=r=>{if(!r||typeof r!="string"||r.split("-").length!==3)return"";const[y,w,f]=r.split("-");return`${f}/${w}/${y}`},Te=({task:r,onSave:y})=>{const w=_=>{try{if(!_||typeof _!="string")return{assignDate:"",dueDate:"",logs:[]};const p=JSON.parse(_);return{assignDate:p.assignDate||"",dueDate:p.dueDate||"",logs:Array.isArray(p.logs)?p.logs:[]}}catch(p){return console.error("Error parsing dates JSON in DatesManager:",p),{assignDate:"",dueDate:"",logs:[]}}},[f,F]=i.useState(()=>w(r.dates));i.useEffect(()=>{F(w(r.dates))},[r.dates]);const m=_=>{const{name:p,value:B}=_.target,N=Pe(B),L={...w(r.dates),[p]:N};y(r.id,{dates:JSON.stringify(L)})};return e.jsxs("div",{className:"flex flex-col gap-1 text-xs p-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{htmlFor:`assignDate-${r.id}`,className:"font-semibold text-gray-600 mr-2 whitespace-nowrap",children:"Asig:"}),e.jsx("input",{id:`assignDate-${r.id}`,name:"assignDate",type:"date",value:ee(f.assignDate),onChange:m,className:"p-1 border border-gray-200 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 w-full"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{htmlFor:`dueDate-${r.id}`,className:"font-semibold text-gray-600 mr-2 whitespace-nowrap",children:"Límite:"}),e.jsx("input",{id:`dueDate-${r.id}`,name:"dueDate",type:"date",value:ee(f.dueDate),onChange:m,className:"p-1 border border-gray-200 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 w-full"})]})]})},C={PENDIENTE:"Pendiente",EN_PROCESO:"En Progreso",COMPLETADO:"Completado",CANCELADO:"Cancelado",EN_REVISION:"En Revisión",BLOQUEADO:"Bloqueado",APROBACION_REQUERIDA:"Aprobación Requerida",EN_DISENO:"En Diseño",EN_DISCUSION:"En Discusión"},Ae=r=>({Pendiente:"bg-yellow-100 text-yellow-800","En Progreso":"bg-blue-100 text-blue-800",Completado:"bg-green-100 text-green-800",Cancelado:"bg-red-100 text-red-800","En Revisión":"bg-purple-100 text-purple-800",Bloqueado:"bg-gray-400 text-white","Aprobación Requerida":"bg-orange-100 text-orange-800","En Diseño":"bg-pink-100 text-pink-800","En Discusión":"bg-indigo-100 text-indigo-800"})[r]||"bg-gray-100 text-gray-800",Oe=r=>({Baja:"bg-blue-100 text-blue-800","Media-Baja":"bg-green-100 text-green-800",Media:"bg-yellow-100 text-yellow-800","Media-Alta":"bg-orange-200 text-orange-900",Alta:"bg-red-500 text-white font-bold"})[r]||"bg-gray-100 text-gray-800",R=[{key:"Priority",label:"Prioridad",width:75,sortable:!0},{key:"stage_id",label:"Etapa",width:75,sortable:!0},{key:"task_description",label:"Tarea / Espacio",width:350,sortable:!0},{key:"inline_actions",label:"Acciones de Tarea",width:500,sortable:!1},{key:"status",label:"Estado",width:75,sortable:!0},{key:"Progress",label:"Progreso",width:100,sortable:!0},{key:"staff_id",label:"Responsable",width:90,sortable:!0},{key:"entregable_id",label:"Entregable",width:120,sortable:!0},{key:"dates",label:"Fechas",width:250,sortable:!0},{key:"notes",label:"Notas",width:300,sortable:!0}],Fe=()=>{const r=he(),[y,w]=i.useState([]),[f,F]=i.useState([]),[m,_]=i.useState([]),[p,B]=i.useState([]),[N,W]=i.useState([]),[L,Me]=i.useState([{id:"Baja",name:"Baja"},{id:"Media-Baja",name:"Media-Baja"},{id:"Media",name:"Media"},{id:"Media-Alta",name:"Media-Alta"},{id:"Alta",name:"Alta"}]),[se,$]=i.useState(!1),[g,S]=i.useState({project_id:"",stage_id:"",staff_id:"",status:"",search:""}),[D,z]=i.useState(new Set),[v,te]=i.useState({key:"task_description",direction:"ascending"}),[K,ae]=i.useState(new Set),[V,re]=i.useState(R.reduce((t,s)=>({...t,[s.key]:s.width}),{})),M=i.useRef(null),P=async()=>{const t=await r(O("Tareas"));t!=null&&t.payload&&w(t.payload)};i.useEffect(()=>{(async()=>{const[s,a,o,l]=await Promise.all([r(O("Proyectos")),r(O("Staff")),r(O("Stage")),r(O("Entregables_template"))]);s!=null&&s.payload&&F(s.payload),a!=null&&a.payload&&_(a.payload),o!=null&&o.payload&&B(o.payload),l!=null&&l.payload&&W(l.payload)})(),P()},[r]);const q=i.useMemo(()=>{let t=[...y];if(g.search){const s=g.search.toLowerCase();t=t.filter(a=>Object.values(a).some(o=>String(o).toLowerCase().includes(s)))}return g.project_id&&(t=t.filter(s=>s.project_id===g.project_id)),g.stage_id&&(t=t.filter(s=>s.stage_id===g.stage_id)),g.staff_id&&(t=t.filter(s=>s.staff_id===g.staff_id)),g.status&&(t=t.filter(s=>s.status===g.status)),t},[y,g]),T=i.useMemo(()=>{let t=[...q];return v.key!==null&&t.sort((s,a)=>{const o=(c,b)=>{var j,h,I,n;let u=c[b]||"";switch(b){case"project_id":return((j=f.find(d=>d.id===u))==null?void 0:j.name)||u;case"staff_id":return((h=m.find(d=>d.id===u))==null?void 0:h.name)||u;case"stage_id":return((I=p.find(d=>d.id===u))==null?void 0:I.name)||u;case"entregable_id":return((n=N.find(d=>d.id===u))==null?void 0:n.entregable_nombre)||u;case"dates":return c.dates&&JSON.parse(c.dates).dueDate||"";case"Progress":return Number(u||0);default:return u}},l=o(s,v.key),x=o(a,v.key);return l<x?v.direction==="ascending"?-1:1:l>x?v.direction==="ascending"?1:-1:0}),t.reduce((s,a)=>{var l;const o=((l=f.find(x=>x.id===a.project_id))==null?void 0:l.name)||"Tareas sin Proyecto";return s[o]||(s[o]=[]),s[o].push(a),s},{})},[q,v,f,m,p,N]),ne=t=>{ae(s=>{const a=new Set(s);return a.has(t)?a.delete(t):a.add(t),a})},le=t=>{let s="ascending";v.key===t&&v.direction==="ascending"&&(s="descending"),te({key:t,direction:s})},oe=t=>{z(s=>{const a=new Set(s);return a.has(t)?a.delete(t):a.add(t),a})},ie=t=>{const s={...t};["project_id","staff_id","stage_id","entregable_id"].forEach(a=>{s[a]===""&&(s[a]=null)}),r(Y(s)).then(P),$(!1)},G=(t,s)=>{r(Z(t,s)).then(()=>{w(a=>a.map(o=>o.id===t?{...o,...s}:o))})},de=t=>{const s=Array.from(D).map(a=>r(Z(a,t)));Promise.all(s).then(()=>{P(),A()})},ce=()=>{if(window.confirm(`¿Estás seguro de que quieres eliminar ${D.size} tarea(s)?`)){const t=Array.from(D).map(s=>r(_e(s)));Promise.all(t).then(()=>{P(),A()})}},ue=()=>{const s=y.filter(a=>D.has(a.id)).map(a=>{const{id:o,created_at:l,...x}=a;return r(Y({...x,task_description:`${a.task_description} (Copia)`,status:C.PENDIENTE,Progress:0}))});Promise.all(s).then(()=>{P(),A()})},A=()=>z(new Set),k=({rowId:t,field:s,value:a,type:o="text",options:l=[]})=>{const[x,c]=i.useState(!1),[b,u]=i.useState(a),j=()=>{let n=b;if(o==="progress"&&(n=Math.max(0,Math.min(100,Number(n)||0))),n!==a){let d={[s]:n};s==="Progress"&&n===100&&(d.status="Completado"),G(t,d)}c(!1)},h=n=>{n.key==="Enter"&&o!=="textarea"?j():n.key==="Escape"&&(u(a),c(!1))};if(x)switch(o){case"progress":return e.jsx("input",{type:"number",min:"0",max:"100",value:b||0,onChange:n=>u(n.target.value),onBlur:j,onKeyDown:h,className:"w-full p-1 border rounded focus:outline-none bg-transparent",autoFocus:!0});case"select":case"status-select":case"priority-select":return e.jsxs("select",{value:b||"",onChange:n=>u(n.target.value),onBlur:j,onKeyDown:h,className:"w-full p-1 border rounded focus:outline-none bg-white",autoFocus:!0,children:[e.jsx("option",{value:"",children:"-- Seleccionar --"}),l.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]});case"entregable-select":return e.jsxs("select",{value:b||"",onChange:n=>u(n.target.value),onBlur:j,onKeyDown:h,className:"w-full p-1 border rounded focus:outline-none",autoFocus:!0,children:[e.jsx("option",{value:"",children:"-- Seleccionar --"}),l.map(n=>e.jsx("option",{value:n.id,children:n.entregable_nombre},n.id))]});default:return e.jsx("textarea",{value:b||"",onChange:n=>u(n.target.value),onBlur:j,onKeyDown:h,className:"w-full p-1 border rounded focus:outline-none",rows:"3",autoFocus:!0})}const I=(n,d)=>{var X,J,Q,H;switch(n){case"project_id":return((X=f.find(E=>E.id===d))==null?void 0:X.name)||d||"-";case"staff_id":return((J=m.find(E=>E.id===d))==null?void 0:J.name)||d||"-";case"stage_id":return((Q=p.find(E=>E.id===d))==null?void 0:Q.name)||d||"-";case"entregable_id":return((H=N.find(E=>E.id===d))==null?void 0:H.entregable_nombre)||d||"-";default:return d||"-"}};if(s==="Progress"){const n=Math.max(0,Math.min(100,Number(a)||0));return e.jsx("div",{className:"w-full p-1 cursor-pointer",onClick:()=>c(!0),children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:"text-xs font-semibold mr-2 w-8",children:[n,"%"]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:e.jsx("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:`${n}%`}})})]})})}return s==="status"?e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium cursor-pointer ${Ae(a)}`,onClick:()=>c(!0),children:a||"-"}):s==="Priority"?e.jsx("div",{className:"cursor-pointer p-1 min-h-[28px]",onClick:()=>c(!0),children:a||"-"}):e.jsx("div",{className:"cursor-pointer p-1 min-h-[28px]",onClick:()=>c(!0),children:I(s,a)})},pe=i.useCallback((t,s)=>{t.preventDefault(),M.current={key:s,startX:t.clientX,startWidth:V[s]}},[V]);i.useEffect(()=>{const t=a=>{if(!M.current)return;const{key:o,startX:l,startWidth:x}=M.current,c=x+(a.clientX-l);c>50&&re(b=>({...b,[o]:c}))},s=()=>{M.current=null};return window.addEventListener("mousemove",t),window.addEventListener("mouseup",s),()=>{window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",s)}},[]);const ge=()=>{const t=Object.values(T).flat().map(l=>{var c,b,u,j;const x=l.dates?JSON.parse(l.dates):{};return{Proyecto:((c=f.find(h=>h.id===l.project_id))==null?void 0:c.name)||"N/A",Prioridad:l.Priority||"-",Etapa:((b=p.find(h=>h.id===l.stage_id))==null?void 0:b.name)||"-",Tarea:l.task_description,Estado:l.status,"Progreso (%)":l.Progress||0,Responsable:((u=m.find(h=>h.id===l.staff_id))==null?void 0:u.name)||"Sin Asignar",Entregable:((j=N.find(h=>h.id===l.entregable_id))==null?void 0:j.entregable_nombre)||"-","Fecha Asignación":x.assignDate||"-","Fecha Límite":x.dueDate||"-",Notas:l.notes||""}}),s=U.json_to_sheet(t),a=U.book_new();U.book_append_sheet(a,s,"Tareas");const o=Object.keys(t[0]||{}).map(l=>({wch:Math.max(...t.map(x=>{var c;return((c=x[l])==null?void 0:c.toString().length)||10}),l.length)}));s["!cols"]=o,Ce(a,"Gestion_de_Tareas.xlsx")};return e.jsxs(e.Fragment,{children:[e.jsx(fe,{isOpen:se,onClose:()=>$(!1),onSubmit:ie,proyectos:f,staff:m,stages:p,entregables:N,estados:C}),e.jsxs("div",{className:"flex flex-col h-screen bg-gray-50",children:[e.jsxs("div",{className:"bg-white shadow-sm border-b p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Gestión de Tareas"}),e.jsx("p",{className:"text-gray-600",children:"Vista de Hoja de Cálculo Interactiva"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:ge,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:[e.jsx(De,{size:16})," Exportar"]}),e.jsxs("button",{onClick:()=>$(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(be,{size:16})," Nueva Tarea"]})]})]}),e.jsxs("div",{className:"grid grid-cols-6 gap-4 p-2 bg-gray-50 rounded-lg border",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Búsqueda General"}),e.jsxs("div",{className:"relative",children:[e.jsx(me,{size:16,className:"absolute left-3 top-3 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Buscar en toda la tabla...",value:g.search,onChange:t=>S(s=>({...s,search:t.target.value})),className:"pl-10 w-full p-2 border border-gray-300 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Etapa"}),e.jsxs("select",{value:g.stage_id,onChange:t=>S(s=>({...s,stage_id:t.target.value})),className:"w-full p-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"Todas"}),p.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Responsable"}),e.jsxs("select",{value:g.staff_id,onChange:t=>S(s=>({...s,staff_id:t.target.value})),className:"w-full p-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"Todos"}),m.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Estado"}),e.jsxs("select",{value:g.status,onChange:t=>S(s=>({...s,status:t.target.value})),className:"w-full p-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"Todos"}),Object.values(C).map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("button",{onClick:()=>S({project_id:"",stage_id:"",staff_id:"",status:"",search:""}),className:"flex items-center justify-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 w-full",children:[e.jsx(Ee,{size:16})," Limpiar"]})})]})]}),e.jsx("div",{className:"flex-1 overflow-auto",children:e.jsx("div",{className:"min-w-full",children:e.jsxs("table",{className:"w-full bg-white text-sm",style:{tableLayout:"fixed"},children:[e.jsxs("colgroup",{children:[e.jsx("col",{style:{width:"48px"}})," ",R.map(t=>e.jsx("col",{style:{width:`${V[t.key]}px`}},t.key))]}),e.jsx("thead",{className:"bg-gray-100 sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b",children:e.jsx("input",{type:"checkbox",onChange:t=>t.target.checked?z(new Set(Object.values(T).flat().map(s=>s.id))):A()})}),R.map(t=>e.jsxs("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b relative group",children:[e.jsx("div",{className:"flex items-center justify-between",children:t.sortable?e.jsxs("button",{onClick:()=>le(t.key),className:"flex items-center gap-1 hover:text-gray-800",children:[t.label," ",e.jsx(Se,{size:12})]}):e.jsx("span",{children:t.label})}),e.jsx("div",{onMouseDown:s=>pe(s,t.key),className:"absolute top-0 right-0 h-full w-2 cursor-col-resize bg-blue-300 opacity-0 group-hover:opacity-100"})]},t.key))]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:Object.keys(T).sort().map(t=>e.jsxs(ye.Fragment,{children:[e.jsx("tr",{className:"bg-gray-200 sticky top-12 z-10 cursor-pointer",onClick:()=>ne(t),children:e.jsx("td",{colSpan:R.length+1,className:"py-2 px-4 font-bold text-gray-700",children:e.jsxs("div",{className:"flex items-center gap-2",children:[K.has(t)?e.jsx(je,{size:16}):e.jsx(we,{size:16}),t," (",T[t].length,")"]})})}),!K.has(t)&&T[t].map(s=>e.jsxs("tr",{className:`hover:bg-gray-50 ${D.has(s.id)?"bg-blue-50":""}`,children:[e.jsx("td",{className:"px-4 py-2 border-r align-top",children:e.jsx("input",{type:"checkbox",checked:D.has(s.id),onChange:()=>oe(s.id)})}),e.jsx("td",{className:`px-4 py-2 border-r text-center align-top ${Oe(s.Priority)}`,children:e.jsx(k,{rowId:s.id,field:"Priority",value:s.Priority,type:"priority-select",options:L})}),e.jsx("td",{className:"px-4 py-2 border-r align-top",children:e.jsx(k,{rowId:s.id,field:"stage_id",value:s.stage_id,type:"select",options:p})}),e.jsx("td",{className:"px-4 py-2 border-r align-top",children:e.jsx(k,{rowId:s.id,field:"task_description",value:s.task_description,type:"textarea"})}),e.jsx("td",{className:"p-0 border-r align-top",children:e.jsx(Ne,{task:s})}),e.jsx("td",{className:"px-4 py-2 border-r text-center align-top",children:e.jsx(k,{rowId:s.id,field:"status",value:s.status,type:"status-select",options:Object.keys(C).map(a=>({id:C[a],name:C[a]}))})}),e.jsx("td",{className:"px-4 py-2 border-r align-top",children:e.jsx(k,{rowId:s.id,field:"Progress",value:s.Progress,type:"progress"})}),e.jsx("td",{className:"px-4 py-2 border-r align-top",children:e.jsx(k,{rowId:s.id,field:"staff_id",value:s.staff_id,type:"select",options:m})}),e.jsx("td",{className:"px-4 py-2 border-r align-top",children:e.jsx(k,{rowId:s.id,field:"entregable_id",value:s.entregable_id,type:"entregable-select",options:N})}),e.jsxs("td",{className:"px-4 py-2 border-r align-top",children:[e.jsx(Te,{task:s,onSave:G}),e.jsx(ve,{task:s,proyectos:f,staff:m,stages:p,entregables:N,updateCell:G})]}),e.jsx("td",{className:"px-4 py-2 border-r align-top",children:e.jsx(k,{rowId:s.id,field:"notes",value:s.notes,type:"textarea"})})]},s.id))]},t))})]})})}),e.jsx(ke,{selectedRows:D,data:q,staff:m,updateMultipleTasks:de,handleBulkDelete:ce,handleDuplicateTasks:ue,deselectAll:A})]})]})};export{Fe as default};
//# sourceMappingURL=ProjectExcelView-CTO962-B.js.map
